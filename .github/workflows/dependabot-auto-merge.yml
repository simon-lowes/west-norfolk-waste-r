name: Dependabot Auto-Merge

on: pull_request

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  claude-review:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Review and fix dependency update
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_bots: "dependabot[bot]"
          prompt: |
            You are the dependency maintainer for this project. A dependabot PR has been opened.
            Your job is to ensure this update is safe, fix any problems it introduces, and approve it — or request changes if it's genuinely dangerous.

            AUTONOMOUS MODE — do NOT ask questions or wait for input. Make all decisions yourself.

            ## Step 1: Identify what changed

            Read package.json and the PR diff. Identify:
            - Which package(s) were bumped
            - From what version to what version
            - Whether this is patch, minor, or major

            ## Step 2: React version consistency (CRITICAL)

            This project has been broken before by react/react-dom version mismatches (React error #527, white screen crash).

            Check package.json:
            - "react" and "react-dom" in dependencies MUST be the exact same version, pinned without ^ or ~
            - The "overrides" block MUST pin both to the same version
            - If dependabot bumped react but not react-dom (or vice versa), YOU MUST FIX THIS:
              1. Update the lagging package to match the bumped one
              2. Update the overrides block to match
              3. Run: npm install --legacy-peer-deps
              4. Verify the build passes: npm run build
              5. Commit and push the fix to this PR branch

            ## Step 3: Peer dependency check

            Run: npm ls --all 2>&1 | grep "ERESOLVE\|peer dep\|invalid" || echo "No peer dep issues"
            If there are peer dependency conflicts, assess whether they are blocking (build fails) or cosmetic (warnings only).

            ## Step 4: Changelog review

            Search the web for the changelog or release notes of the updated package. Summarise:
            - Security fixes (flag these prominently)
            - Breaking changes (flag these as blockers for major updates)
            - Notable new features or deprecations
            - If you can't find a changelog, note that and check the npm page instead

            ## Step 5: Build verification

            Run: npm run build
            If the build fails, investigate and fix if possible. If you can't fix it, request changes.

            ## Step 6: Post your review

            Post a PR review with:
            - **Package**: name, old version → new version
            - **Type**: patch/minor/major
            - **What changed**: 1-2 sentence summary from the changelog
            - **Security**: any security fixes (or "None noted")
            - **Concerns**: any issues found and what you did about them (or "None")
            - **Fixes applied**: list any commits you pushed to this branch (or "None needed")

            If everything is safe: APPROVE the PR.
            If you found unfixable issues: REQUEST CHANGES with clear explanation.

  auto-merge:
    runs-on: ubuntu-latest
    needs: [claude-review]
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-merge patch and minor updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-patch' || steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on major updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-major'
        run: |
          gh pr comment "$PR_URL" --body "⚠️ **Major version update detected.** This PR requires manual review before merging.

          Please check the changelog for breaking changes."
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
